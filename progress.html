<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COMPASS - Adherence Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="script.js" defer></script>
  <style>
    .risk-meter {
      width: 200px;
      height: 200px;
      position: relative;
      margin: 0 auto;
    }

    .shield-display {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }

    .shield {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #06B6D4, #38BDF8);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      position: relative;
      animation: float 3s ease-in-out infinite;
    }

    .shield.used {
      background: linear-gradient(135deg, #94A3B8, #CBD5E1);
      opacity: 0.5;
    }

    .shield::after {
      content: 'üõ°Ô∏è';
      position: absolute;
      font-size: 30px;
    }

    .adherence-chart {
      height: 300px;
      margin: 20px 0;
      position: relative;
    }

    #adherenceChart {
      width: 100% !important;
      height: 100% !important;
    }

    .risk-badge {
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
    }

    .risk-low {
      background: linear-gradient(135deg, #10B981, #34D399);
      color: white;
    }

    .risk-medium {
      background: linear-gradient(135deg, #F59E0B, #FBBF24);
      color: white;
    }

    .risk-high {
      background: linear-gradient(135deg, #EF4444, #F87171);
      color: white;
    }

    .risk-critical {
      background: linear-gradient(135deg, #DC2626, #EF4444);
      color: white;
    }

    .abdm-badge {
      background: linear-gradient(135deg, #0EA5E9, #3B82F6);
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .abdm-badge:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3);
    }

    .whatsapp-integration {
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
      padding: 15px;
      border-radius: 20px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }
  </style>
</head>

<body data-theme="neon">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="user-info">
        <div class="user-avatar" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
          <i data-lucide="bar-chart"></i>
        </div>
        <div class="greeting">
          <h1>Adherence Dashboard <span class="text-gradient float-animation">üìä</span></h1>
          <p><i data-lucide="activity"></i> Real-time compliance analytics</p>
        </div>
      </div>

      <a href="settings.html" class="header-settings-icon" aria-label="Settings">
        <i data-lucide="settings"></i>
      </a>

      <div class="header-controls">
        <button class="btn-secondary" onclick="window.location.href='index.html'">
          <i data-lucide="arrow-left"></i> Home
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <h1 class="page-title">Smart Medication Adherence Analytics</h1>

    <!-- Risk & Streak Overview -->
    <div class="card" style="margin-bottom: 30px;">
      <div class="card-content" style="padding: 30px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px;">
          <!-- Current Streak -->
          <div style="text-align: center;">
            <div style="font-size: 48px; font-weight: 900;" class="text-gradient current-streak">7</div>
            <div style="color: var(--muted-2);">Current Streak</div>
            <div style="margin-top: 10px; font-size: 14px; color: var(--accent-1);">
              <i data-lucide="flame"></i> On fire!
            </div>
          </div>

          <!-- Safety Shields -->
          <div style="text-align: center;">
            <div class="shield-display">
              <div class="shield active"></div>
              <div class="shield used"></div>
              <div class="shield used"></div>
            </div>
            <div style="color: var(--muted-2);">Safety Shields</div>
            <div style="margin-top: 10px; font-size: 14px; color: var(--accent-2);">
              <i data-lucide="shield"></i> <span class="shield-count">1</span> active
            </div>
          </div>

          <!-- Risk Score -->
          <div style="text-align: center;">
            <div id="risk-score-display" style="font-size: 48px; font-weight: 900;" class="risk-score">25</div>
            <div style="color: var(--muted-2);">Risk Score</div>
            <div id="risk-level-badge" class="risk-badge risk-low" style="margin-top: 10px;">
              <i data-lucide="shield"></i> Low Risk
            </div>
          </div>
        </div>

        <!-- Risk Explanation -->
        <div style="margin-top: 20px; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 15px;">
          <div style="font-weight: bold; margin-bottom: 10px; color: var(--fg);">
            <i data-lucide="info"></i> Risk Score Explained
          </div>
          <div style="color: var(--muted-2); font-size: 14px; line-height: 1.6;">
            Your risk score (0-100) predicts likelihood of medication non-adherence.
            <span style="color: var(--ok);">Lower is better.</span> Factors: Streak length, shield usage, recent misses.
            Score updates in real-time with your compliance behavior.
          </div>
        </div>
      </div>
    </div>

    <!-- Adherence Chart -->
    <div class="card" style="margin-bottom: 30px;">
      <div class="card-content" style="padding: 30px;">
        <h2 style="margin-bottom: 20px; color: var(--fg);">
          <i data-lucide="trending-up"></i> 30-Day Adherence Trend
        </h2>
        <div class="adherence-chart">
          <canvas id="adherenceChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Behavioral Nudge Engine -->
    <div class="card" style="margin-bottom: 30px;">
      <div class="card-content" style="padding: 30px;">
        <h2 style="margin-bottom: 20px; color: var(--fg);">
          <i data-lucide="message-circle"></i> Behavioral Nudge Engine
        </h2>

        <div class="whatsapp-integration">
          <div style="font-size: 36px;">üì±</div>
          <div style="flex: 1;">
            <div style="font-weight: bold;">WhatsApp Integration</div>
            <div style="font-size: 14px; opacity: 0.9;">High-priority alerts sent when streak is at risk</div>
          </div>
          <button class="btn-secondary" style="background: white; color: #128C7E;" onclick="testWhatsAppNudge()">
            <i data-lucide="send"></i> Test Alert
          </button>
        </div>

        <div style="margin-top: 20px;">
          <h3 style="margin-bottom: 15px; color: var(--fg);">Recent Nudges</h3>
          <div id="nudge-history" style="max-height: 200px; overflow-y: auto;">
            <!-- Nudges will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- ABDM Integration -->
    <div class="card" style="margin-bottom: 40px;">
      <div class="card-content" style="padding: 30px;">
        <h2 style="margin-bottom: 20px; color: var(--fg);">
          <i data-lucide="share-2"></i> Healthcare Provider Sharing
        </h2>

        <div style="text-align: center; margin: 30px 0;">
          <div class="abdm-badge" onclick="exportABDMData()">
            <i data-lucide="download"></i>
            <div>
              <div style="font-weight: bold;">Export ABDM Data</div>
              <div style="font-size: 12px; opacity: 0.9;">Share with your doctor securely</div>
            </div>
          </div>
        </div>

        <div style="color: var(--muted-2); font-size: 14px; text-align: center;">
          <i data-lucide="shield-check"></i> ABDM-compatible data export.
          Securely share your adherence metrics with healthcare providers.
        </div>
      </div>
    </div>

    <!-- Action Center -->
    <div class="card" style="margin-bottom: 40px;">
      <div class="card-content" style="padding: 30px;">
        <h2 style="margin-bottom: 20px; color: var(--fg);">Quick Actions</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <button class="btn-primary" onclick="window.location.href='todo.html'">
            <i data-lucide="list-checks"></i> Complete Tasks
          </button>
          <button class="btn-secondary" onclick="useSafetyShield()">
            <i data-lucide="shield"></i> Use Safety Shield
          </button>
          <button class="btn-secondary" onclick="sendMotivationalNudge()">
            <i data-lucide="message-square"></i> Get Motivation
          </button>
          <button class="btn-secondary" onclick="window.ComplianceCoach?.missTask()">
            <i data-lucide="x-circle"></i> Simulate Missed Dose
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <i data-lucide="home"></i>
      <span>Home</span>
    </a>
    <a href="todo.html" class="nav-item active">
      <i data-lucide="list-checks"></i>
      <span>To-Do</span>
    </a>
    <div class="sos-button" onmousedown="startSOSCountdown()"
      onmouseup='this.innerHTML = "<i data-lucide=\"siren\"></i>"' ontouchstart="startSOSCountdown()"
      ontouchend='this.innerHTML = "<i data-lucide=\"siren\"></i>"'>
      <i data-lucide="siren"></i>
    </div>
    <a href="progress.html" class="nav-item">
      <i data-lucide="trending-up"></i>
      <span>Dashboard</span>
    </a>
    <a href="gamification.html" class="nav-item">
      <i data-lucide="gamepad-2"></i>
      <span>Game</span>
    </a>
  </nav>

  <script>
    // Dashboard-specific functionality
    let adherenceChart;

    function getAdherenceData() {
      // Get actual data from ComplianceCoach or generate sample data
      if (window.ComplianceCoach && window.ComplianceCoach.state.adherenceHistory.length > 0) {
        return window.ComplianceCoach.state.adherenceHistory.slice(-30);
      }
      
      // Generate sample data if no real data exists
      const sampleData = [];
      const today = new Date();
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(today.getDate() - i);
        
        sampleData.push({
          date: date.toISOString(),
          completed: Math.random() > 0.3, // 70% adherence rate
          riskLevel: Math.floor(Math.random() * 100) // Random risk score
        });
      }
      
      return sampleData;
    }

    function initDashboard() {
      console.log('Initializing dashboard...');
      
      // Initialize ComplianceCoach if not exists
      if (!window.ComplianceCoach) {
        console.log('Creating new ComplianceCoach instance');
        window.ComplianceCoach = new ComplianceCoach();
      }
      
      // Wait for DOM and libraries to be ready
      setTimeout(() => {
        console.log('Updating dashboard displays...');
        updateRiskDisplay();
        loadAdherenceChart();
        loadNudgeHistory();
        
        // Update icons
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
        
        // Force chart resize for better display
        if (adherenceChart) {
          setTimeout(() => {
            adherenceChart.resize();
            console.log('Chart resized');
          }, 200);
        }
      }, 200);
    }

    function updateRiskDisplay() {
      console.log('Updating risk display...');
      if (window.ComplianceCoach) {
        const riskLevel = window.ComplianceCoach.getRiskLevel();
        const badge = document.getElementById('risk-level-badge');
        const scoreDisplay = document.getElementById('risk-score-display');

        // Update risk score
        if (scoreDisplay) {
          scoreDisplay.textContent = riskLevel.score || 25;
        }

        // Update badge
        if (badge) {
          badge.className = 'risk-badge';
          badge.classList.add(`risk-${riskLevel.level || 'low'}`);
          badge.innerHTML = `<i data-lucide="${riskLevel.level === 'low' ? 'shield-check' : 'alert-circle'}"></i> ${riskLevel.label || 'Low Risk'}`;
        }

        // Update shields
        updateShieldDisplay();

        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }
    }

    function updateShieldDisplay() {
      if (!window.ComplianceCoach) return;

      const shields = document.querySelectorAll('.shield');
      const shieldCountElement = document.querySelector('.shield-count');
      const activeShields = window.ComplianceCoach.state.safetyShields || 0;

      // Update shield count display
      if (shieldCountElement) {
        shieldCountElement.textContent = activeShields;
      }

      shields.forEach((shield, index) => {
        if (index < activeShields) {
          shield.classList.remove('used');
          shield.classList.add('active');
        } else {
          shield.classList.add('used');
          shield.classList.remove('active');
        }
      });
    }

    function loadAdherenceChart() {
      console.log('Loading adherence chart...');
      const ctx = document.getElementById('adherenceChart');
      if (!ctx) {
        console.error('Chart canvas element not found!');
        return;
      }

      // Get data
      const history = getAdherenceData();
      
      // Check if we have data
      if (!history || history.length === 0) {
        console.error('No adherence data available');
        return;
      }
      
      // Prepare labels
      const labels = history.map(h => {
        try {
          const date = new Date(h.date);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } catch (e) {
          return 'N/A';
        }
      });

      // Prepare datasets
      const adherenceData = history.map(h => h.completed ? 100 : 0);
      const riskData = history.map(h => h.riskLevel || 0);

      // Clear any existing chart
      if (adherenceChart) {
        adherenceChart.destroy();
      }

      // Create new chart
      adherenceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Adherence %',
              data: adherenceData,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4
            },
            {
              label: 'Risk Score',
              data: riskData,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.3,
              fill: false,
              yAxisID: 'y1',
              pointBackgroundColor: '#EF4444',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            x: {
              grid: {
                display: true,
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                maxTicksLimit: 10,
                color: 'var(--muted-2)'
              }
            },
            y: {
              beginAtZero: true,
              min: 0,
              max: 100,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'var(--muted-2)',
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            y1: {
              beginAtZero: true,
              min: 0,
              max: 100,
              position: 'right',
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: 'var(--muted-2)'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: 'var(--fg)',
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#8B5CF6',
              borderWidth: 1,
              callbacks: {
                label: function (context) {
                  if (context.dataset.label === 'Adherence %') {
                    return `Adherence: ${context.parsed.y}%`;
                  } else {
                    return `Risk Score: ${context.parsed.y}/100`;
                  }
                }
              }
            }
          }
        }
      });
      
      console.log('Chart created successfully');
    }

    function loadNudgeHistory() {
      const container = document.getElementById('nudge-history');
      if (!container) return;

      const notifications = JSON.parse(localStorage.getItem('whatsappNotifications') || '[]');

      if (notifications.length === 0) {
        container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--muted-2);">
                        <i data-lucide="message-square"></i>
                        <div>No recent nudges. Complete tasks to see personalized messages!</div>
                    </div>
                `;
        return;
      }

      container.innerHTML = notifications.slice(-5).reverse().map(n => `
                <div style="padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; margin-bottom: 10px;">
                    <div style="font-size: 12px; color: var(--accent-1); margin-bottom: 5px;">
                        ${new Date(n.timestamp).toLocaleString()}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 20px;">üì±</div>
                        <div style="flex: 1;">${n.message}</div>
                    </div>
                </div>
            `).join('');
    }

    function testWhatsAppNudge() {
      if (window.ComplianceCoach) {
        window.ComplianceCoach.sendWhatsAppNudge("Test: This is a behavioral nudge from COMPASS Health Coach!");
      } else {
        alert('Test WhatsApp nudge sent! (Simulated)');
      }
      setTimeout(loadNudgeHistory, 500);
    }

    function exportABDMData() {
      if (window.ComplianceCoach) {
        window.ComplianceCoach.exportABDMData();
      } else {
        alert('ABDM data export simulated. In production, this would generate ABDM-compatible JSON.');
      }
    }

    function useSafetyShield() {
      if (confirm('Use a Safety Shield?\n\nThis will protect your streak from one missed dose.')) {
        if (window.ComplianceCoach && window.ComplianceCoach.state.safetyShields > 0) {
          window.ComplianceCoach.state.safetyShields--;
          window.ComplianceCoach.saveState();
          updateShieldDisplay();
          alert('üõ°Ô∏è Safety Shield activated! Your streak is protected for one missed dose.');
        } else {
          alert('No Safety Shields available. Complete a 7-day streak to earn one!');
        }
      }
    }

    function sendMotivationalNudge() {
      const messages = [
        "You're doing amazing! Keep up the great work! üí™",
        "Every dose taken is a step toward better health! üéØ",
        "Your consistency is inspiring! üåü",
        "Remember why you started. You've got this! üî•",
        "Proud of your progress! Keep that streak going! üèÜ"
      ];

      const randomMessage = messages[Math.floor(Math.random() * messages.length)];

      if (window.ComplianceCoach) {
        window.ComplianceCoach.sendInAppNudge(randomMessage);
      } else {
        alert(`üí¨ ${randomMessage}`);
      }
    }

    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded, initializing dashboard...');
      
      // Wait for all scripts and libraries to load
      setTimeout(initDashboard, 1000);
      
      // Update displays periodically
      setInterval(updateRiskDisplay, 30000);
      setInterval(loadAdherenceChart, 60000);
    });

    // Also initialize when window loads
    window.addEventListener('load', function() {
      console.log('Window loaded, checking chart...');
      if (!adherenceChart) {
        setTimeout(initDashboard, 500);
      }
    });
  </script>

  <script>
    // Insert streak header on page load
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize compliance coach
      if (!window.ComplianceCoach) {
        window.ComplianceCoach = new ComplianceCoach();
      }

      // Insert streak header
      insertStreakHeader();

      // Update streak header every minute for real-time updates
      setInterval(() => {
        if (window.ComplianceCoach) {
          window.ComplianceCoach.updateStreakHeader();
        }
      }, 60000);
    });
  </script>
</body>

</html>
